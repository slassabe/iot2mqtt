<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iot2mqtt.central &mdash; iot2mqtt 2.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=51b770b3"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            iot2mqtt
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">iot2mqtt: Simplifying IoT Solutions with MQTT Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts.html">Core Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userguide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">iot2mqtt</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">iot2mqtt</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">iot2mqtt.central</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for iot2mqtt.central</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/local/bin/python3</span>
<span class="c1"># coding=utf-8</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for managing MQTT topics and processing messages for IoT devices.</span>

<span class="sd">This module includes classes and functions to manage MQTT topic configurations,</span>
<span class="sd">subscribe to topics, process incoming messages, and trigger state changes on devices.</span>
<span class="sd">It supports multiple protocols such as Zigbee2MQTT and Tasmota.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">paho.mqtt.client</span> <span class="k">as</span> <span class="nn">mqtt</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>

<span class="kn">from</span> <span class="nn">iot2mqtt</span> <span class="kn">import</span> <span class="p">(</span><span class="n">abstract</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">messenger</span><span class="p">,</span> <span class="n">mqtthelper</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span>
                      <span class="n">utils</span><span class="p">)</span>

<span class="n">Z2M_INFO_BASE_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;zigbee2mqtt&quot;</span>
<span class="n">Z2M_CMND_BASE_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;zigbee2mqtt&quot;</span>
<span class="n">TASMOTA_INFO_BASE_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;tele&quot;</span>
<span class="n">TASMOTA_CMND_BASE_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;cmnd&quot;</span>
<span class="n">TASMOTA_DISCOVERY_TOPIC</span> <span class="o">=</span> <span class="s2">&quot;tasmota/discovery&quot;</span>

<span class="n">DEFAULT_ON_TIME</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">DEFAULT_OFF_TIME</span> <span class="o">=</span> <span class="mf">0.0</span>


<span class="k">class</span> <span class="nc">_TopicManager</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">Singleton</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A registry for managing topic configurations based on protocol and message type.</span>

<span class="sd">    This class provides a centralized way to store and retrieve topic configurations</span>
<span class="sd">    for different combinations of protocol and message type. It acts as a registry</span>
<span class="sd">    for topic configurations, allowing easy access to the topic base, topic extension,</span>
<span class="sd">    and device name offset for a given protocol and message type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># self._topic_registry: Dict[TopicRegistryKey, &quot;TopicManager&quot;] = {}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_topic_registry</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">class</span> <span class="nc">_CommandTopicManager</span><span class="p">(</span><span class="n">_TopicManager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages command topics for different protocols.</span>

<span class="sd">    This class provides methods to register and retrieve command base topics</span>
<span class="sd">    for various protocols. It acts as a registry for command topic configurations,</span>
<span class="sd">    allowing easy access to the command base topic for a given protocol.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span>
        <span class="n">command_topic_base</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a command topic base for a given protocol.</span>

<span class="sd">        Args:</span>
<span class="sd">            protocol (dev.Protocol): The protocol for which the command topic base is</span>
<span class="sd">                being registered.</span>
<span class="sd">            command_topic_base (str): The base topic for commands of the given protocol.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the protocol is already registered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topic_registry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Protocol is already registered&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_topic_registry</span><span class="p">[</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_topic_base</span>

    <span class="k">def</span> <span class="nf">get_command_base_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the command base topic for a given protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topic_registry</span><span class="p">[</span><span class="n">protocol</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">configure_topic_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the topic registry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_prefix</span> <span class="o">=</span> <span class="s2">&quot;TEST/&quot;</span>
        <span class="n">_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span> <span class="n">command_topic_base</span><span class="o">=</span><span class="n">_prefix</span> <span class="o">+</span> <span class="n">Z2M_INFO_BASE_TOPIC</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span><span class="p">,</span>
            <span class="n">command_topic_base</span><span class="o">=</span><span class="n">_prefix</span> <span class="o">+</span> <span class="n">TASMOTA_CMND_BASE_TOPIC</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">_InfoTopicRegistryKey</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A key used to uniquely identify a topic configuration based on the</span>
<span class="sd">    protocol and message type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span>
    <span class="n">message_type</span><span class="p">:</span> <span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="s2">&quot;Pydantic configuration for the InfoTopicRegistryKey class.&quot;</span>
        <span class="n">frozen</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">_InfoTopicRegistry</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Registered values for a given protocol and message type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">info_topic_base</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">topic_to_subscribe</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">device_name_offset</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">class</span> <span class="nc">_InfoTopicManager</span><span class="p">(</span><span class="n">_TopicManager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages topic configurations for different protocols and message types.</span>

<span class="sd">    This class provides methods to register, retrieve, and resolve MQTT topics</span>
<span class="sd">    based on protocol and message type. It acts as a registry for topic configurations,</span>
<span class="sd">    allowing easy access to the topic base, topic extension, and device name offset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">resolve_wildcards</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span>
        <span class="n">message_type</span><span class="p">:</span> <span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="p">,</span>
        <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">position</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolve wildcards in the topic based on the protocol and message type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_registry_key</span> <span class="o">=</span> <span class="n">_InfoTopicRegistryKey</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span>
        <span class="p">)</span>
        <span class="n">_registry_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topic_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_registry_key</span><span class="p">)</span>
        <span class="n">_offset</span> <span class="o">=</span> <span class="n">_registry_value</span><span class="o">.</span><span class="n">device_name_offset</span>
        <span class="n">_result</span> <span class="o">=</span> <span class="n">topic</span><span class="p">[</span><span class="n">_offset</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="n">position</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">_result</span>

    <span class="k">def</span> <span class="nf">get_sub_topic</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span> <span class="n">message_type</span><span class="p">:</span> <span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the sub-topic from the given topic based on the protocol and message type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_registry_key</span> <span class="o">=</span> <span class="n">_InfoTopicRegistryKey</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span>
        <span class="p">)</span>
        <span class="n">_registry_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topic_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_registry_key</span><span class="p">)</span>
        <span class="n">_offset</span> <span class="o">=</span> <span class="n">_registry_value</span><span class="o">.</span><span class="n">device_name_offset</span>
        <span class="n">_sub_topic</span> <span class="o">=</span> <span class="n">topic</span><span class="p">[</span><span class="n">_offset</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">_sub_topic</span>

    <span class="k">def</span> <span class="nf">get_topic_to_subscribe</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span> <span class="n">message_type</span><span class="p">:</span> <span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the topic to subscribe to based on the protocol and message type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_registry_key</span> <span class="o">=</span> <span class="n">_InfoTopicRegistryKey</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span>
        <span class="p">)</span>
        <span class="n">_registry_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topic_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_registry_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_registry_value</span><span class="o">.</span><span class="n">topic_to_subscribe</span>

    <span class="k">def</span> <span class="nf">get_all_topics_to_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of all topics to subscribe to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">topic_to_subscribe</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topic_registry</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span>
        <span class="n">message_type</span><span class="p">:</span> <span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="p">,</span>
        <span class="n">info_topic_base</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">info_topic_extension</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a topic configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_registry_key</span> <span class="o">=</span> <span class="n">_InfoTopicRegistryKey</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">_registry_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topic_registry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Key is already registered&quot;</span><span class="p">)</span>
        <span class="n">_registry_value</span> <span class="o">=</span> <span class="n">_InfoTopicRegistry</span><span class="p">(</span>
            <span class="n">info_topic_base</span><span class="o">=</span><span class="n">info_topic_base</span><span class="p">,</span>
            <span class="n">topic_to_subscribe</span><span class="o">=</span><span class="n">info_topic_base</span> <span class="o">+</span> <span class="n">info_topic_extension</span><span class="p">,</span>
            <span class="n">device_name_offset</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">info_topic_base</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_topic_registry</span><span class="p">[</span><span class="n">_registry_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_registry_value</span>

    <span class="k">def</span> <span class="nf">configure_topic_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the topic registry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">AVAIL</span><span class="p">,</span>
            <span class="n">info_topic_base</span><span class="o">=</span><span class="n">Z2M_INFO_BASE_TOPIC</span><span class="p">,</span>
            <span class="n">info_topic_extension</span><span class="o">=</span><span class="s2">&quot;/+/availability&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">AVAIL</span><span class="p">,</span>
            <span class="n">info_topic_base</span><span class="o">=</span><span class="n">TASMOTA_INFO_BASE_TOPIC</span><span class="p">,</span>
            <span class="n">info_topic_extension</span><span class="o">=</span><span class="s2">&quot;/+/LWT&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">STATE</span><span class="p">,</span>
            <span class="n">info_topic_base</span><span class="o">=</span><span class="n">Z2M_INFO_BASE_TOPIC</span><span class="p">,</span>
            <span class="n">info_topic_extension</span><span class="o">=</span><span class="s2">&quot;/+&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">STATE</span><span class="p">,</span>
            <span class="n">info_topic_base</span><span class="o">=</span><span class="n">TASMOTA_INFO_BASE_TOPIC</span><span class="p">,</span>
            <span class="n">info_topic_extension</span><span class="o">=</span><span class="s2">&quot;/+/+&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">DISCO</span><span class="p">,</span>
            <span class="n">info_topic_base</span><span class="o">=</span><span class="n">Z2M_INFO_BASE_TOPIC</span><span class="p">,</span>
            <span class="n">info_topic_extension</span><span class="o">=</span><span class="s2">&quot;/bridge/devices&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">DISCO</span><span class="p">,</span>
            <span class="n">info_topic_base</span><span class="o">=</span><span class="n">TASMOTA_DISCOVERY_TOPIC</span><span class="p">,</span>
            <span class="n">info_topic_extension</span><span class="o">=</span><span class="s2">&quot;/+/config&quot;</span><span class="p">,</span>
        <span class="p">)</span>


<div class="viewcode-block" id="Scrutinizer">
<a class="viewcode-back" href="../../iot2mqtt.html#iot2mqtt.central.Scrutinizer">[docs]</a>
<span class="k">class</span> <span class="nc">Scrutinizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class responsible for subscribing to MQTT topics and processing incoming messages.</span>

<span class="sd">    The Scrutinizer class subscribes to various MQTT topics based on protocol and message type,</span>
<span class="sd">    processes incoming messages, and places the processed messages into an output queue of</span>
<span class="sd">    raw data.</span>

<span class="sd">    Args:</span>
<span class="sd">        mqtt_client (mqtthelper.ClientHelper): The MQTT client helper instance.</span>
<span class="sd">        output_queue (Queue): The queue where the raw data is placed.</span>
<span class="sd">        queue_timeout (int, optional): Timeout for queue operations in seconds. Defaults to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Reference to Frank Zappa - The Central Scrutinizer ‚ù§</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mqtt_client</span><span class="p">:</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">ClientHelper</span><span class="p">,</span>
        <span class="n">output_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span>
        <span class="n">queue_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># timeout in sec.</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mqtt_client</span> <span class="o">=</span> <span class="n">mqtt_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_queue</span> <span class="o">=</span> <span class="n">output_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue_timeout</span> <span class="o">=</span> <span class="n">queue_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subscribe_to_topics</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_subscribe_to_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">_callback_add</span><span class="p">(</span>
            <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span>
            <span class="n">message_type</span><span class="p">:</span> <span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="p">,</span>
            <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">messenger</span><span class="o">.</span><span class="n">Message</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
        <span class="p">):</span>
            <span class="n">_topic</span> <span class="o">=</span> <span class="n">_InfoTopicManager</span><span class="p">()</span><span class="o">.</span><span class="n">get_topic_to_subscribe</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">message_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mqtt_client</span><span class="o">.</span><span class="n">message_callback_add</span><span class="p">(</span><span class="n">_topic</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>

        <span class="n">_z2m</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span>
        <span class="n">_tasmota</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span>
        <span class="n">_avail</span> <span class="o">=</span> <span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">AVAIL</span>
        <span class="n">_state</span> <span class="o">=</span> <span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">STATE</span>
        <span class="n">_disco</span> <span class="o">=</span> <span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">DISCO</span>
        <span class="c1"># Set availability handlers</span>
        <span class="n">_callback_add</span><span class="p">(</span><span class="n">_z2m</span><span class="p">,</span> <span class="n">_avail</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_z2m_avail</span><span class="p">)</span>
        <span class="n">_callback_add</span><span class="p">(</span><span class="n">_tasmota</span><span class="p">,</span> <span class="n">_avail</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_tasmota_avail</span><span class="p">)</span>
        <span class="c1"># Set state handlers</span>
        <span class="n">_callback_add</span><span class="p">(</span><span class="n">_z2m</span><span class="p">,</span> <span class="n">_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_z2m_state</span><span class="p">)</span>
        <span class="n">_callback_add</span><span class="p">(</span><span class="n">_tasmota</span><span class="p">,</span> <span class="n">_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_tasmota_state</span><span class="p">)</span>
        <span class="c1"># Set discovery handlers</span>
        <span class="n">_callback_add</span><span class="p">(</span><span class="n">_z2m</span><span class="p">,</span> <span class="n">_disco</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_z2m_disco</span><span class="p">)</span>
        <span class="n">_callback_add</span><span class="p">(</span><span class="n">_tasmota</span><span class="p">,</span> <span class="n">_disco</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_tasmota_disco</span><span class="p">)</span>
        <span class="c1"># Set connection handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mqtt_client</span><span class="o">.</span><span class="n">connect_handler_add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_connect</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_json_to_item</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span>
        <span class="n">message_type</span><span class="p">:</span> <span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="p">,</span>
        <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">messenger</span><span class="o">.</span><span class="n">Item</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a JSON payload to a messenger.Item object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">_tag</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span><span class="p">:</span>
                <span class="n">_tag</span> <span class="o">=</span> <span class="n">_InfoTopicManager</span><span class="p">()</span><span class="o">.</span><span class="n">resolve_wildcards</span><span class="p">(</span>
                    <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
                    <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span><span class="p">,</span>
                    <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
                    <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">messenger</span><span class="o">.</span><span class="n">Item</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">_payload</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">_tag</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Failed to parse message: </span><span class="si">%s</span><span class="s2"> - data: </span><span class="si">%s</span><span class="s2"> - tag: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">errors</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]),</span>
                <span class="n">_payload</span><span class="p">,</span>
                <span class="n">_tag</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_process_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">Client</span><span class="p">,</span>  <span class="c1"># pylint: disable=unused-argument</span>
        <span class="n">userdata</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>  <span class="c1"># pylint: disable=unused-argument</span>
        <span class="n">mqtt_message</span><span class="p">:</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">MQTTMessage</span><span class="p">,</span>
        <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span>
        <span class="n">message_type</span><span class="p">:</span> <span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process an incoming MQTT message and put the result in the output queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">mqtt_message</span><span class="o">.</span><span class="n">topic</span>
        <span class="n">_raw_payload</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mqtt_message</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">_raw_payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received empty message on topic </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">_device_name</span> <span class="o">=</span> <span class="n">_InfoTopicManager</span><span class="p">()</span><span class="o">.</span><span class="n">resolve_wildcards</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="n">topic</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_to_item</span><span class="p">(</span>
                <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span><span class="p">,</span>
                <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
                <span class="n">payload</span><span class="o">=</span><span class="n">_raw_payload</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="n">_is_tasmota</span> <span class="o">=</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span>
            <span class="n">_is_state</span> <span class="o">=</span> <span class="n">message_type</span> <span class="o">==</span> <span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">STATE</span>
            <span class="k">if</span> <span class="n">_is_tasmota</span> <span class="ow">and</span> <span class="n">_is_state</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] dismissed topic&quot;</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">_item</span> <span class="o">=</span> <span class="n">messenger</span><span class="o">.</span><span class="n">Item</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">_raw_payload</span><span class="p">)</span>
        <span class="n">_incoming</span> <span class="o">=</span> <span class="n">messenger</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">device_name</span><span class="o">=</span><span class="n">_device_name</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span><span class="p">,</span>
            <span class="n">raw_item</span><span class="o">=</span><span class="n">_item</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">_incoming</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_queue_timeout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_z2m_avail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">argc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_message</span><span class="p">(</span>
            <span class="o">*</span><span class="n">argc</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">AVAIL</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_tasmota_avail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">argc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_message</span><span class="p">(</span>
            <span class="o">*</span><span class="n">argc</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">AVAIL</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_z2m_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">argc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_message</span><span class="p">(</span>
            <span class="o">*</span><span class="n">argc</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">STATE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_tasmota_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">argc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_message</span><span class="p">(</span>
            <span class="o">*</span><span class="n">argc</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">STATE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_z2m_disco</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">argc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_message</span><span class="p">(</span>
            <span class="o">*</span><span class="n">argc</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">DISCO</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_tasmota_disco</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">argc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_message</span><span class="p">(</span>
            <span class="o">*</span><span class="n">argc</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">messenger</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">DISCO</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_connect</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-arguments</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">Client</span><span class="p">,</span>
        <span class="n">userdata</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>  <span class="c1"># pylint: disable=unused-argument</span>
        <span class="n">flags</span><span class="p">:</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">ConnectFlags</span><span class="p">,</span>  <span class="c1"># pylint: disable=unused-argument</span>
        <span class="n">reason_code</span><span class="p">:</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">ReasonCode</span><span class="p">,</span>  <span class="c1"># pylint: disable=unused-argument</span>
        <span class="n">properties</span><span class="p">:</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">Properties</span><span class="p">,</span>  <span class="c1"># pylint: disable=unused-argument</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subscribes to MQTT topics on connection.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_topic</span> <span class="ow">in</span> <span class="n">_InfoTopicManager</span><span class="p">()</span><span class="o">.</span><span class="n">get_all_topics_to_subscribe</span><span class="p">():</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Subscribing to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_topic</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">_topic</span><span class="p">)</span></div>



<span class="k">class</span> <span class="nc">_TimerManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to manage timers for devices, ensuring thread safety and preventing multiple timers</span>
<span class="sd">    from being active for the same device in case of bouncing messages</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer_registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer_registry_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_timer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">device_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">countdown</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manages a timer for a specific device, ensuring that only one timer is active per device.</span>

<span class="sd">        This method creates and starts a new timer for the given device. If a timer for the device</span>
<span class="sd">        already exists, it cancels the existing timer before starting a new one. The timer will call</span>
<span class="sd">        the specified function (`task`) with the provided arguments (`args` and `kwargs`) after</span>
<span class="sd">        the countdown period.</span>

<span class="sd">        Args:</span>
<span class="sd">            device_name (str): The name of the device for which the timer is being managed.</span>
<span class="sd">            countdown (float): The countdown period in seconds after which the `task` function</span>
<span class="sd">                will be executed.</span>
<span class="sd">            task (Callable[..., Any]): The function to be called when the timer expires.</span>
<span class="sd">            args (tuple, optional): Positional arguments to be passed to the `task` function.</span>
<span class="sd">                Defaults to ().</span>
<span class="sd">            kwargs (Optional[Dict[str, Any]], optional): Keyword arguments to be passed to the</span>
<span class="sd">                `task` function. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            threading.Thread: The newly created and started timer thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_registry_lock</span><span class="p">:</span>
                <span class="n">_previous_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">device_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_previous_timer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Replace previous timer for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">device_name</span><span class="p">)</span>
                    <span class="n">_previous_timer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="n">_timer</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">countdown</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">_timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_timer_registry</span><span class="p">[</span><span class="n">device_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_timer</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Failed to manage timer for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span>


<span class="n">timer_manager</span> <span class="o">=</span> <span class="n">_TimerManager</span><span class="p">()</span>


<div class="viewcode-block" id="is_timer_active">
<a class="viewcode-back" href="../../iot2mqtt.html#iot2mqtt.central.is_timer_active">[docs]</a>
<span class="k">def</span> <span class="nf">is_timer_active</span><span class="p">(</span><span class="n">device_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if a timer is active for a specific device.</span>

<span class="sd">    Args:</span>
<span class="sd">        device_name (str): The name of the device to check for an active timer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if a timer is active for the specified device, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">device_name</span> <span class="ow">in</span> <span class="n">timer_manager</span><span class="o">.</span><span class="n">_timer_registry</span></div>



<div class="viewcode-block" id="DeviceAccessor">
<a class="viewcode-back" href="../../iot2mqtt.html#iot2mqtt.central.DeviceAccessor">[docs]</a>
<span class="k">class</span> <span class="nc">DeviceAccessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class responsible for accessing device state via MQTT.</span>

<span class="sd">    This class provides methods to trigger the retrieval of the current state of a device</span>
<span class="sd">    using the MQTT protocol. It interacts with the MQTT client to publish state retrieval</span>
<span class="sd">    or state change commands to the appropriate MQTT topics based on the device model and</span>
<span class="sd">    protocol.</span>

<span class="sd">    Args:</span>
<span class="sd">        mqtt_client (mqtthelper.ClientHelper): An instance of the MQTT client helper used</span>
<span class="sd">            to publish messages to MQTT topics.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mqtt_client</span><span class="p">:</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">ClientHelper</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mqtt_client</span> <span class="o">=</span> <span class="n">mqtt_client</span>

<div class="viewcode-block" id="DeviceAccessor.trigger_get_state">
<a class="viewcode-back" href="../../iot2mqtt.html#iot2mqtt.central.DeviceAccessor.trigger_get_state">[docs]</a>
    <span class="k">def</span> <span class="nf">trigger_get_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">device_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Model</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Triggers the retrieval of the current state of a device via MQTT.</span>

<span class="sd">        This method publishes state retrieval commands to the appropriate MQTT topics based</span>
<span class="sd">        on the device model and protocol. It uses the encoder registry to get the fields</span>
<span class="sd">        that can be retrieved for the given device model and constructs the MQTT topics</span>
<span class="sd">        accordingly.</span>

<span class="sd">        Args:</span>
<span class="sd">            device_name (str): The name of the device for which the state is being retrieved.</span>
<span class="sd">            protocol (dev.Protocol): The communication protocol used by the device (e.g., Z2M, TASMOTA).</span>
<span class="sd">            model (dev.Model): The model of the device.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If the protocol is unknown or not supported.</span>

<span class="sd">        Note:</span>
<span class="sd">            If the encoder for the given device model is not found, a debug message is logged</span>
<span class="sd">            and the method returns without publishing any messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_command_base_topic</span> <span class="o">=</span> <span class="n">_CommandTopicManager</span><span class="p">()</span><span class="o">.</span><span class="n">get_command_base_topic</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>
        <span class="n">_encoder</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">EncoderRegistry</span><span class="o">.</span><span class="n">get_encoder</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_encoder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cannot get state for model: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">_fields</span> <span class="o">=</span> <span class="n">_encoder</span><span class="o">.</span><span class="n">gettable_fields</span>
        <span class="k">if</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">:</span>
            <span class="n">_command_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_command_base_topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">/get&quot;</span>
            <span class="n">_pl</span> <span class="o">=</span> <span class="p">{</span><span class="n">_field</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">_field</span> <span class="ow">in</span> <span class="n">_fields</span><span class="p">}</span>
            <span class="n">_command_payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">_pl</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Publishing state retrieval to </span><span class="si">%s</span><span class="s2"> - state : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">_command_topic</span><span class="p">,</span>
                <span class="n">_command_payload</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mqtt_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                <span class="n">_command_topic</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">_command_payload</span><span class="p">,</span> <span class="n">qos</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">retain</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_field</span> <span class="ow">in</span> <span class="n">_fields</span><span class="p">:</span>
                <span class="n">_command_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_command_base_topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">_field</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Publishing state retrieval to </span><span class="si">%s</span><span class="s2"> - state : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">_command_topic</span><span class="p">,</span>
                    <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mqtt_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                    <span class="n">_command_topic</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">qos</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">retain</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">_error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unknown protocol </span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">_error_msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="DeviceAccessor.trigger_change_state">
<a class="viewcode-back" href="../../iot2mqtt.html#iot2mqtt.central.DeviceAccessor.trigger_change_state">[docs]</a>
    <span class="k">def</span> <span class="nf">trigger_change_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">device_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publish a state change message to the MQTT topic for the given device.</span>

<span class="sd">        Args:</span>
<span class="sd">            device_name (str): The name of the device.</span>
<span class="sd">            protocol (dev.Protocol): The communication protocol.</span>
<span class="sd">            state (Dict): The new state to be published.</span>

<span class="sd">        Note:</span>
<span class="sd">            Refer to the documentation of the :mod:`iot2mqtt.abstract` module to generate the state,</span>
<span class="sd">            by the use of the `model_dump` method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_command_base_topic</span> <span class="o">=</span> <span class="n">_CommandTopicManager</span><span class="p">()</span><span class="o">.</span><span class="n">get_command_base_topic</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>
        <span class="n">_json_state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">:</span>
            <span class="n">_command_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_command_base_topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">/set&quot;</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Publishing state change to </span><span class="si">%s</span><span class="s2"> - state : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">_command_topic</span><span class="p">,</span>
                <span class="n">_json_state</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mqtt_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                <span class="n">_command_topic</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">_json_state</span><span class="p">,</span> <span class="n">qos</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">retain</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_key</span><span class="p">,</span> <span class="n">_value</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_command_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_command_base_topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">_key</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Publishing state change to </span><span class="si">%s</span><span class="s2"> - state : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_command_topic</span><span class="p">,</span> <span class="n">_value</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mqtt_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
                    <span class="n">_command_topic</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">_value</span><span class="p">),</span> <span class="n">qos</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">retain</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">_error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unknown protocol </span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">_error_msg</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_do_switch_power</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">device_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
        <span class="n">power_on</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Switching power of </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">power_on</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger_change_state</span><span class="p">(</span>
            <span class="n">device_name</span><span class="o">=</span><span class="n">device_name</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">abstract</span><span class="o">.</span><span class="n">SWITCH_ON</span> <span class="k">if</span> <span class="n">power_on</span> <span class="k">else</span> <span class="n">abstract</span><span class="o">.</span><span class="n">SWITCH_OFF</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_switch_power_change</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">device_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
        <span class="n">power_on</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">countdown</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">on_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">off_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This method performs the following steps:</span>
        <span class="c1"># 1. If a countdown is specified (countdown != 0), it schedules the power state change to</span>
        <span class="c1">#    occurafter the countdown period. It uses the TimerManager to manage the countdown and</span>
        <span class="c1">#    calls switch_power_change again with countdown set to 0.</span>
        <span class="c1"># 2. If no countdown is specified, it immediately changes the power state of the device by</span>
        <span class="c1">#    calling the _do_switch_power method.</span>
        <span class="c1"># 3. If the device is being turned on and an on_time is specified (on_time &gt; 0), it</span>
        <span class="c1">#    schedules the device to be turned off after the on_time period using the TimerManager</span>
        <span class="c1"># 4. If the device is being turned off and an off_time is specified (off_time &gt; 0), it</span>
        <span class="c1">#    schedules the device to be turned on after the off_time period using the TimerManager</span>

        <span class="k">def</span> <span class="nf">_manage_timer_helper</span><span class="p">(</span><span class="n">_power_on</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">_countdown</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;device_name&quot;</span><span class="p">:</span> <span class="n">device_name</span><span class="p">,</span>
                <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="n">protocol</span><span class="p">,</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="s2">&quot;power_on&quot;</span><span class="p">:</span> <span class="n">_power_on</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">timer_manager</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span>
                <span class="n">device_name</span><span class="o">=</span><span class="n">device_name</span><span class="p">,</span>
                <span class="n">countdown</span><span class="o">=</span><span class="n">_countdown</span><span class="p">,</span>
                <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_do_switch_power</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="n">_params</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">countdown</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;device_names&quot;</span><span class="p">:</span> <span class="n">device_name</span><span class="p">,</span>
                <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="n">protocol</span><span class="p">,</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="s2">&quot;power_on&quot;</span><span class="p">:</span> <span class="n">power_on</span><span class="p">,</span>
                <span class="s2">&quot;countdown&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;on_time&quot;</span><span class="p">:</span> <span class="n">on_time</span><span class="p">,</span>
                <span class="s2">&quot;off_time&quot;</span><span class="p">:</span> <span class="n">off_time</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">timer_manager</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span>
                <span class="n">device_name</span><span class="o">=</span><span class="n">device_name</span><span class="p">,</span>
                <span class="n">countdown</span><span class="o">=</span><span class="n">countdown</span><span class="p">,</span>
                <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_power_change</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="n">_params</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_switch_power</span><span class="p">(</span>
                <span class="n">device_name</span><span class="o">=</span><span class="n">device_name</span><span class="p">,</span>
                <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">power_on</span><span class="o">=</span><span class="n">power_on</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">power_on</span> <span class="ow">and</span> <span class="n">on_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_manage_timer_helper</span><span class="p">(</span><span class="n">_power_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_countdown</span><span class="o">=</span><span class="n">on_time</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">power_on</span> <span class="ow">and</span> <span class="n">off_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_manage_timer_helper</span><span class="p">(</span><span class="n">_power_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_countdown</span><span class="o">=</span><span class="n">off_time</span><span class="p">)</span>

<div class="viewcode-block" id="DeviceAccessor.switch_power_change">
<a class="viewcode-back" href="../../iot2mqtt.html#iot2mqtt.central.DeviceAccessor.switch_power_change">[docs]</a>
    <span class="k">def</span> <span class="nf">switch_power_change</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">device_names</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">protocol</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">dev</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
        <span class="n">power_on</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">countdown</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">on_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_ON_TIME</span><span class="p">,</span>
        <span class="n">off_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_OFF_TIME</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manage the power state change of switch devices.</span>

<span class="sd">        This function handles the power state change of switchs, optionally scheduling</span>
<span class="sd">        the change to occur after a countdown. It also manages the timing for turning</span>
<span class="sd">        the devices on and off based on the provided on_time and off_time parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            device_names (str): A comma-separated string of switch names.</span>
<span class="sd">            protocol (dev.Protocol): The protocol used by the device.</span>
<span class="sd">            model (dev.Model): The model of the device.</span>
<span class="sd">            power_on (bool): The desired power state (True for ON, False for OFF).</span>
<span class="sd">            countdown (float, optional): The countdown time in seconds before the power state</span>
<span class="sd">                change occurs. Defaults to 0.</span>
<span class="sd">            on_time (float, optional): The duration in seconds to keep the device ON.</span>
<span class="sd">                Defaults to DEFAULT_ON_TIME.</span>
<span class="sd">            off_time (float, optional): The duration in seconds to keep the device OFF.</span>
<span class="sd">                Defaults to DEFAULT_OFF_TIME.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Note:</span>
<span class="sd">            The discovery step is not required for this function to work, but the protocol and</span>
<span class="sd">            model must be provided compared to :func:`switch_power_change_helper` function.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">device_name</span> <span class="ow">in</span> <span class="n">device_names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_switch_power_change</span><span class="p">(</span>
                <span class="n">device_name</span><span class="o">=</span><span class="n">device_name</span><span class="p">,</span>
                <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">power_on</span><span class="o">=</span><span class="n">power_on</span><span class="p">,</span>
                <span class="n">countdown</span><span class="o">=</span><span class="n">countdown</span><span class="p">,</span>
                <span class="n">on_time</span><span class="o">=</span><span class="n">on_time</span><span class="p">,</span>
                <span class="n">off_time</span><span class="o">=</span><span class="n">off_time</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="DeviceAccessor.switch_power_change_helper">
<a class="viewcode-back" href="../../iot2mqtt.html#iot2mqtt.central.DeviceAccessor.switch_power_change_helper">[docs]</a>
    <span class="k">def</span> <span class="nf">switch_power_change_helper</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">device_names</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">power_on</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">countdown</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">on_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_ON_TIME</span><span class="p">,</span>
        <span class="n">off_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_OFF_TIME</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to change the power state of switch devices.</span>

<span class="sd">        This function retrieves devices from the device directory based on the provided</span>
<span class="sd">        device names, and then calls the `switch_power_change` function to change their</span>
<span class="sd">        power state.</span>

<span class="sd">        Args:</span>
<span class="sd">            device_names (str): A comma-separated string of switch names.</span>
<span class="sd">            power_on (bool): The desired power state. True to power on, False to power off.</span>
<span class="sd">            countdown (float, optional): The countdown period in seconds before changing</span>
<span class="sd">                the power state. Defaults to 0.</span>
<span class="sd">            on_time (float, optional): The duration in seconds for which the device should</span>
<span class="sd">                remain powered on. Defaults to DEFAULT_ON_TIME.</span>
<span class="sd">            off_time (float, optional): The duration in seconds for which the device should</span>
<span class="sd">                remain powered off. Defaults to DEFAULT_OFF_TIME.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Note:</span>
<span class="sd">            The discovery step must be performed before calling this function.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">device_name</span> <span class="ow">in</span> <span class="n">device_names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="c1"># Retrieve the device from the device directory</span>
            <span class="n">_device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dev</span><span class="o">.</span><span class="n">Device</span><span class="p">]</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">DeviceDirectory</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span>
                <span class="n">device_name</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">_device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">devices</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">DeviceDirectory</span><span class="o">.</span><span class="n">get_device_names</span><span class="p">()</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Device </span><span class="si">%s</span><span class="s2"> not found in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">devices</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># Call the switch_power_change function with the retrieved device&#39;s protocol and model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_switch_power_change</span><span class="p">(</span>
                <span class="n">device_name</span><span class="o">=</span><span class="n">device_name</span><span class="p">,</span>
                <span class="n">protocol</span><span class="o">=</span><span class="n">_device</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">_device</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">power_on</span><span class="o">=</span><span class="n">power_on</span><span class="p">,</span>
                <span class="n">countdown</span><span class="o">=</span><span class="n">countdown</span><span class="p">,</span>
                <span class="n">on_time</span><span class="o">=</span><span class="n">on_time</span><span class="p">,</span>
                <span class="n">off_time</span><span class="o">=</span><span class="n">off_time</span><span class="p">,</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="get_refined_data_queue">
<a class="viewcode-back" href="../../iot2mqtt.html#iot2mqtt.central.get_refined_data_queue">[docs]</a>
<span class="k">def</span> <span class="nf">get_refined_data_queue</span><span class="p">(</span><span class="n">mqtt_client</span><span class="p">:</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">ClientHelper</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Queue</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates and returns a queue of refined messages by processing raw messages from MQTT.</span>

<span class="sd">    Args:</span>
<span class="sd">        mqtt_client (mqtthelper.ClientHelper): The MQTT client helper instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Queue: The queue containing the refined (processed) messages.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_raw_data_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">_layer1_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">_layer2_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">_refined_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">Scrutinizer</span><span class="p">(</span><span class="n">mqtt_client</span><span class="o">=</span><span class="n">mqtt_client</span><span class="p">,</span> <span class="n">output_queue</span><span class="o">=</span><span class="n">_raw_data_queue</span><span class="p">)</span>

    <span class="n">messenger</span><span class="o">.</span><span class="n">Dispatcher</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pipeline-discovery&quot;</span><span class="p">,</span>
        <span class="n">input_queue</span><span class="o">=</span><span class="n">_raw_data_queue</span><span class="p">,</span>
        <span class="n">output_queue</span><span class="o">=</span><span class="n">_layer1_queue</span><span class="p">,</span>
        <span class="n">conditional_handlers</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="n">messenger</span><span class="o">.</span><span class="n">is_type_discovery</span><span class="p">,</span> <span class="n">processor</span><span class="o">.</span><span class="n">Discoverer</span><span class="p">()</span><span class="o">.</span><span class="n">process</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="c1"># copy Discovery message to output queue</span>
        <span class="n">default_handler</span><span class="o">=</span><span class="n">processor</span><span class="o">.</span><span class="n">Processor</span><span class="o">.</span><span class="n">pass_through</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Listen to receive all discovery messages</span>
    <span class="n">_accessor</span> <span class="o">=</span> <span class="n">DeviceAccessor</span><span class="p">(</span><span class="n">mqtt_client</span><span class="o">=</span><span class="n">mqtt_client</span><span class="p">)</span>
    <span class="n">messenger</span><span class="o">.</span><span class="n">Dispatcher</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pipeline-layer1&quot;</span><span class="p">,</span>
        <span class="n">input_queue</span><span class="o">=</span><span class="n">_layer1_queue</span><span class="p">,</span>
        <span class="n">output_queue</span><span class="o">=</span><span class="n">_layer2_queue</span><span class="p">,</span>
        <span class="n">conditional_handlers</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="ow">not</span> <span class="n">messenger</span><span class="o">.</span><span class="n">is_type_discovery</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
                <span class="n">processor</span><span class="o">.</span><span class="n">ModelResolver</span><span class="p">()</span><span class="o">.</span><span class="n">process</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="c1"># copy Discovery message to output queue</span>
        <span class="n">default_handler</span><span class="o">=</span><span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">_get_device_state</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">_accessor</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">messenger</span><span class="o">.</span><span class="n">Dispatcher</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;normalizer&quot;</span><span class="p">,</span>
        <span class="n">input_queue</span><span class="o">=</span><span class="n">_layer2_queue</span><span class="p">,</span>
        <span class="n">output_queue</span><span class="o">=</span><span class="n">_refined_queue</span><span class="p">,</span>
        <span class="n">conditional_handlers</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="n">messenger</span><span class="o">.</span><span class="n">is_type_availability</span><span class="p">,</span>
                <span class="n">processor</span><span class="o">.</span><span class="n">AvailabilityNormalizer</span><span class="p">()</span><span class="o">.</span><span class="n">process</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="n">messenger</span><span class="o">.</span><span class="n">is_type_state</span><span class="p">,</span>
                <span class="n">processor</span><span class="o">.</span><span class="n">StateNormalizer</span><span class="p">()</span><span class="o">.</span><span class="n">process</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="c1"># copy Discovery message to output queue</span>
        <span class="n">default_handler</span><span class="o">=</span><span class="n">processor</span><span class="o">.</span><span class="n">Processor</span><span class="o">.</span><span class="n">pass_through</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">_refined_queue</span></div>



<span class="n">_CONFIG_DEVICE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">SN_MINI</span><span class="p">,</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">):</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">SN_MINI_L2</span><span class="p">,</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">):</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">SN_SMART_PLUG</span><span class="p">,</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">):</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">SHELLY_PLUGS</span><span class="p">,</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span><span class="p">):</span> <span class="p">{</span><span class="s2">&quot;POWER&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">SHELLY_UNI</span><span class="p">,</span> <span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">TASMOTA</span><span class="p">):</span> <span class="p">{</span><span class="s2">&quot;POWER1&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;POWER2&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_config_device</span><span class="p">(</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">messenger</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">accessor</span><span class="p">:</span> <span class="n">DeviceAccessor</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">messenger</span><span class="o">.</span><span class="n">Message</span><span class="p">]:</span>
    <span class="n">_registry</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">refined</span>
    <span class="k">for</span> <span class="n">_device_name</span> <span class="ow">in</span> <span class="n">_registry</span><span class="o">.</span><span class="n">device_names</span><span class="p">:</span>
        <span class="n">_device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dev</span><span class="o">.</span><span class="n">Device</span><span class="p">]</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">DeviceDirectory</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span>
            <span class="n">_device_name</span>
        <span class="p">)</span>
        <span class="n">_model</span> <span class="o">=</span> <span class="n">_device</span><span class="o">.</span><span class="n">model</span>
        <span class="n">_protocol</span> <span class="o">=</span> <span class="n">_device</span><span class="o">.</span><span class="n">protocol</span>
        <span class="n">_config_payload</span> <span class="o">=</span> <span class="n">_CONFIG_DEVICE</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">_model</span><span class="p">,</span> <span class="n">_protocol</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">_config_payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No config payload for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_device_name</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">i2m_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Device: </span><span class="si">%s</span><span class="s2"> - Model: </span><span class="si">%s</span><span class="s2"> - Protocol: </span><span class="si">%s</span><span class="s2"> - Payload: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">_device_name</span><span class="p">,</span>
            <span class="n">_model</span><span class="p">,</span>
            <span class="n">_protocol</span><span class="p">,</span>
            <span class="n">_config_payload</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">accessor</span><span class="o">.</span><span class="n">trigger_change_state</span><span class="p">(</span><span class="n">_device_name</span><span class="p">,</span> <span class="n">_protocol</span><span class="p">,</span> <span class="n">_config_payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">message</span>


<span class="k">def</span> <span class="nf">_get_device_state</span><span class="p">(</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">messenger</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">accessor</span><span class="p">:</span> <span class="n">DeviceAccessor</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">messenger</span><span class="o">.</span><span class="n">Message</span><span class="p">]:</span>
    <span class="n">_registry</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">refined</span>
    <span class="k">for</span> <span class="n">_device_name</span> <span class="ow">in</span> <span class="n">_registry</span><span class="o">.</span><span class="n">device_names</span><span class="p">:</span>
        <span class="n">_device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dev</span><span class="o">.</span><span class="n">Device</span><span class="p">]</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">DeviceDirectory</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span>
            <span class="n">_device_name</span>
        <span class="p">)</span>
        <span class="n">_model</span> <span class="o">=</span> <span class="n">_device</span><span class="o">.</span><span class="n">model</span>
        <span class="n">_protocol</span> <span class="o">=</span> <span class="n">_device</span><span class="o">.</span><span class="n">protocol</span>
        <span class="n">accessor</span><span class="o">.</span><span class="n">trigger_get_state</span><span class="p">(</span><span class="n">_device_name</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">_protocol</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">_model</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">message</span>


<span class="n">_InfoTopicManager</span><span class="p">()</span><span class="o">.</span><span class="n">configure_topic_registry</span><span class="p">()</span>
<span class="n">_CommandTopicManager</span><span class="p">()</span><span class="o">.</span><span class="n">configure_topic_registry</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Serge LASSABE.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>