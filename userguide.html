<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Guide &mdash; iot2mqtt 2.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=51b770b3"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="iot2mqtt" href="modules.html" />
    <link rel="prev" title="Core Concepts" href="concepts.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            iot2mqtt
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">iot2mqtt: Simplifying IoT Solutions with MQTT Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="concepts.html">Core Concepts</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-get-device-state">How to Get Device State</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-display-air-sensor-temperature-and-humidity">Example: Display Air Sensor Temperature and Humidity</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#explanation">Explanation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-change-the-state-of-any-device">How to Change the State of Any Device</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-changing-the-state-of-a-neo-nas-alarm">Example: Changing the State of a NEO Nas Alarm</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Explanation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-change-the-state-of-one-or-more-switches">How to Change the State of One or More Switches</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-changing-the-switch-state-knowing-the-protocol-and-model">Example: Changing the Switch State Knowing the Protocol and Model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">Explanation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#example-changing-the-switch-state-by-names">Example: Changing the Switch State by Names</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">Explanation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#wrapup">Wrapup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#script-customization">Script customization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-changing-the-state-of-a-switch-on-motion-detection">Example: Changing the State of a Switch on Motion Detection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">Explanation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#example-changing-the-state-of-a-switch-on-button-action">Example: Changing the State of a Switch on Button Action</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">Explanation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">iot2mqtt</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">iot2mqtt</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">User Guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/userguide.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="user-guide">
<h1>User Guide<a class="headerlink" href="#user-guide" title="Link to this heading"></a></h1>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Make sure your MQTT broker is running and accessible at the specified <code class="docutils literal notranslate"><span class="pre">TARGET</span></code> hostname.</p></li>
<li><p>Make sure Zigbee2MQTT is up and running</p></li>
</ul>
</section>
<section id="how-to-get-device-state">
<h2>How to Get Device State<a class="headerlink" href="#how-to-get-device-state" title="Link to this heading"></a></h2>
<p>This guide explains how to retrieve and display the state of a device, specifically focusing on an air sensor’s temperature and humidity.</p>
<section id="example-display-air-sensor-temperature-and-humidity">
<h3>Example: Display Air Sensor Temperature and Humidity<a class="headerlink" href="#example-display-air-sensor-temperature-and-humidity" title="Link to this heading"></a></h3>
<p>The following example demonstrates how to use the <code class="docutils literal notranslate"><span class="pre">iot2mqtt</span></code> library to connect to an MQTT broker, retrieve messages from an air sensor, and display its temperature and humidity.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">iot2mqtt</span> <span class="kn">import</span> <span class="p">(</span><span class="n">abstract</span><span class="p">,</span> <span class="n">central</span><span class="p">,</span> <span class="n">mqtthelper</span><span class="p">,</span> <span class="n">messenger</span><span class="p">,</span> <span class="n">setup</span><span class="p">)</span>

<span class="c1"># Define the MQTT broker hostname</span>
<span class="n">TARGET</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Initialize the MQTT client helper with the specified context</span>
    <span class="n">_client</span> <span class="o">=</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">ClientHelper</span><span class="p">(</span>
        <span class="n">mqtthelper</span><span class="o">.</span><span class="n">MQTTContext</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">TARGET</span><span class="p">),</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">SecurityContext</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">_client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Get the refined data queue from the central module</span>
    <span class="n">_refined_queue</span> <span class="o">=</span> <span class="n">central</span><span class="o">.</span><span class="n">get_refined_data_queue</span><span class="p">(</span><span class="n">_client</span><span class="p">)</span>

    <span class="c1"># Get and print the next 3 Airsensor messages from the refined data queue</span>
    <span class="n">_nb_messages</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">_nb_messages</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Retrieve the next message from the queue</span>
        <span class="n">_message</span> <span class="o">=</span> <span class="n">_refined_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="c1"># Check if the message was issued by the specified Airsensor Model</span>
        <span class="k">if</span> <span class="n">messenger</span><span class="o">.</span><span class="n">is_type_state</span><span class="p">(</span><span class="n">_message</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_message</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="n">setup</span><span class="o">.</span><span class="n">Models</span><span class="o">.</span><span class="n">SN_AIRSENSOR</span><span class="p">:</span>
            <span class="n">_instance</span><span class="p">:</span> <span class="n">abstract</span><span class="o">.</span><span class="n">AirSensor</span> <span class="o">=</span> <span class="n">_message</span><span class="o">.</span><span class="n">refined</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Air sensor state changed to: </span><span class="si">{</span><span class="n">_instance</span><span class="o">.</span><span class="n">temperature</span><span class="si">}</span><span class="s1"> °C - </span><span class="si">{</span><span class="n">_instance</span><span class="o">.</span><span class="n">humidity</span><span class="si">}</span><span class="s1"> %&#39;</span><span class="p">)</span>
            <span class="n">_nb_messages</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<section id="explanation">
<h4>Explanation<a class="headerlink" href="#explanation" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><em><strong>Initialization</strong></em> : The script initializes the MQTT client helper with the specified hostname and security context and security context and start it.</p></li>
<li><p><em><strong>Data Queue</strong></em> : It retrieves the refined data queue from the central module.</p></li>
<li><p><em><strong>Message Processing</strong></em>: The script continuously processes messages from the refined data queue.</p></li>
<li><p><em><strong>Message Filtering</strong></em>: It checks if the message is of type state and if it was issued by the Airsensor Model.</p></li>
<li><p><em><strong>Display</strong></em>: If the conditions are met, it prints the air sensor’s temperature and humidity :</p>
<ul>
<li><p>Air sensor state changed to: 19.11 °C - 78.77 %</p></li>
<li><p>Air sensor state changed to: 19.02 °C - 78.27 %</p></li>
<li><p>Air sensor state changed to: 19.02 °C - 78.77 %</p></li>
</ul>
</li>
</ul>
<p>This example provides a basic template for integrating with an MQTT broker and processing messages from an air sensor. You can extend this example to handle other types of devices and messages as needed.</p>
</section>
</section>
</section>
<section id="how-to-change-the-state-of-any-device">
<h2>How to Change the State of Any Device<a class="headerlink" href="#how-to-change-the-state-of-any-device" title="Link to this heading"></a></h2>
<p>This section provides examples of how to request a state change for devices using the <code class="docutils literal notranslate"><span class="pre">trigger_change_state()</span></code> method.</p>
<section id="example-changing-the-state-of-a-neo-nas-alarm">
<h3>Example: Changing the State of a NEO Nas Alarm<a class="headerlink" href="#example-changing-the-state-of-a-neo-nas-alarm" title="Link to this heading"></a></h3>
<p>The following example demonstrates how to set the NEO Nas Alarm to ON for 10 seconds.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">iot2mqtt</span> <span class="kn">import</span> <span class="n">dev</span><span class="p">,</span> <span class="n">central</span><span class="p">,</span> <span class="n">mqtthelper</span>

<span class="n">TARGET</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Initialize the MQTT client helper with the target hostname</span>
    <span class="n">_client</span> <span class="o">=</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">ClientHelper</span><span class="p">(</span>
        <span class="n">mqtthelper</span><span class="o">.</span><span class="n">MQTTContext</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">TARGET</span><span class="p">),</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">SecurityContext</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">_client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Create a DeviceAccessor instance with the MQTT client</span>
    <span class="n">_accessor</span> <span class="o">=</span> <span class="n">central</span><span class="o">.</span><span class="n">DeviceAccessor</span><span class="p">(</span><span class="n">mqtt_client</span><span class="o">=</span><span class="n">_client</span><span class="p">)</span>

    <span class="c1"># Define the state to set the Zigbee NEO Nas Alarm ON for 10 seconds</span>
    <span class="n">_state_on</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;alarm&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Trigger the state change on the device</span>
    <span class="n">_accessor</span><span class="o">.</span><span class="n">trigger_change_state</span><span class="p">(</span>
        <span class="n">device_name</span><span class="o">=</span><span class="s2">&quot;ALARM&quot;</span><span class="p">,</span>
        <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
        <span class="n">state</span><span class="o">=</span><span class="n">_state_on</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<section id="id1">
<h4>Explanation<a class="headerlink" href="#id1" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><em><strong>Initialization</strong></em> : The script initializes the MQTT client helper with the specified hostname and security context and start it.</p></li>
<li><p><em><strong>Device Accessor</strong></em> : It creates a <code class="docutils literal notranslate"><span class="pre">DeviceAccessor</span></code> instance with the MQTT client.</p></li>
<li><p><em><strong>State Definition</strong></em> : It defines the state to set the NEO Nas Alarm to ON for 10 seconds.</p></li>
<li><p><em><strong>State Change</strong></em> : It triggers the state change on the device.</p></li>
</ul>
</section>
</section>
</section>
<section id="how-to-change-the-state-of-one-or-more-switches">
<h2>How to Change the State of One or More Switches<a class="headerlink" href="#how-to-change-the-state-of-one-or-more-switches" title="Link to this heading"></a></h2>
<p>This section provides examples of how to request a state change for devices using the <code class="docutils literal notranslate"><span class="pre">trigger_change_state()</span></code> or <code class="docutils literal notranslate"><span class="pre">switch_power_change_helper()</span></code> methods.</p>
<section id="example-changing-the-switch-state-knowing-the-protocol-and-model">
<h3>Example: Changing the Switch State Knowing the Protocol and Model<a class="headerlink" href="#example-changing-the-switch-state-knowing-the-protocol-and-model" title="Link to this heading"></a></h3>
<p>The following example demonstrates how to change the switch state for devices using the <code class="docutils literal notranslate"><span class="pre">switch_power_change()</span></code> method. This method is straightforward as it does not require launching the pipeline and waiting for the devices to be discovered.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">iot2mqtt</span> <span class="kn">import</span> <span class="n">dev</span><span class="p">,</span> <span class="n">central</span><span class="p">,</span> <span class="n">mqtthelper</span><span class="p">,</span> <span class="n">setup</span>

<span class="n">TARGET</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">_client</span> <span class="o">=</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">ClientHelper</span><span class="p">(</span>
        <span class="n">mqtthelper</span><span class="o">.</span><span class="n">MQTTContext</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">TARGET</span><span class="p">),</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">SecurityContext</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">_client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">_accessor</span> <span class="o">=</span> <span class="n">central</span><span class="o">.</span><span class="n">DeviceAccessor</span><span class="p">(</span><span class="n">mqtt_client</span><span class="o">=</span><span class="n">_client</span><span class="p">)</span>
    <span class="c1"># Set switch ON for 5 sec.</span>
    <span class="n">_accessor</span><span class="o">.</span><span class="n">switch_power_change</span><span class="p">(</span>
        <span class="n">device_names</span><span class="o">=</span><span class="s2">&quot;SWITCH_PLUG&quot;</span><span class="p">,</span>
        <span class="n">protocol</span><span class="o">=</span><span class="n">dev</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">setup</span><span class="o">.</span><span class="n">Models</span><span class="o">.</span><span class="n">SN_SMART_PLUG</span><span class="p">,</span>
        <span class="n">power_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">on_time</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

</pre></div>
</div>
<section id="id2">
<h4>Explanation<a class="headerlink" href="#id2" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><em><strong>Initialization</strong></em> : The script initializes the MQTT client helper with the specified hostname and security context and start it.</p></li>
<li><p><em><strong>Device Accessor</strong></em> : It creates a <code class="docutils literal notranslate"><span class="pre">DeviceAccessor</span></code> instance with the MQTT client.</p></li>
<li><p><em><strong>State Change</strong></em> : It triggers the state change on the switch device.</p></li>
<li><p><em><strong>Note</strong></em> : The <code class="docutils literal notranslate"><span class="pre">switch_power_change()</span></code> method is a convenience method that uses the <code class="docutils literal notranslate"><span class="pre">trigger_change_state()</span></code> method under the hood.</p></li>
</ul>
</section>
</section>
<section id="example-changing-the-switch-state-by-names">
<h3>Example: Changing the Switch State by Names<a class="headerlink" href="#example-changing-the-switch-state-by-names" title="Link to this heading"></a></h3>
<p>Alternatively, you can change the switch state for multiple devices using the <code class="docutils literal notranslate"><span class="pre">switch_power_change_helper()</span></code> method. This method is more flexible as it allows changing the state of multiple devices with different protocols or models. It requires initializing the message pipe to discover devices.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">iot2mqtt</span> <span class="kn">import</span> <span class="n">central</span><span class="p">,</span> <span class="n">mqtthelper</span>

<span class="n">TARGET</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
<span class="n">SWITCH1</span> <span class="o">=</span> <span class="s2">&quot;0x00124b0024cb17d3&quot;</span> <span class="c1"># Zigbee switch device</span>
<span class="n">SWITCH2</span> <span class="o">=</span> <span class="s2">&quot;tasmota_577591&quot;</span> <span class="c1"># Tasmota switch device</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">_client</span> <span class="o">=</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">ClientHelper</span><span class="p">(</span>
        <span class="n">mqtthelper</span><span class="o">.</span><span class="n">MQTTContext</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">TARGET</span><span class="p">),</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">SecurityContext</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">_client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c1"># Initialize the message pipe to discover devices</span>
    <span class="n">central</span><span class="o">.</span><span class="n">get_refined_data_queue</span><span class="p">(</span><span class="n">_client</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Wait for the MQTT client to be discovered</span>
    <span class="n">_accessor</span> <span class="o">=</span> <span class="n">central</span><span class="o">.</span><span class="n">DeviceAccessor</span><span class="p">(</span><span class="n">mqtt_client</span><span class="o">=</span><span class="n">_client</span><span class="p">)</span>
    <span class="c1"># Set switch ON for 5 sec.</span>
    <span class="n">_accessor</span><span class="o">.</span><span class="n">switch_power_change_helper</span><span class="p">(</span>
        <span class="n">device_names</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">SWITCH1</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">SWITCH2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">power_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">on_time</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

</pre></div>
</div>
<section id="id3">
<h4>Explanation<a class="headerlink" href="#id3" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><em><strong>Initialization</strong></em> : The script initializes the MQTT client helper with the specified hostname and security context and start it.</p></li>
<li><p><em><strong>Message Pipe</strong></em> : It initializes the message pipe to discover devices.</p></li>
<li><p><em><strong>Wait</strong></em> : It waits 2 sec. for the MQTT client to be discovered.</p></li>
<li><p><em><strong>Device Accessor</strong></em> : It creates a <code class="docutils literal notranslate"><span class="pre">DeviceAccessor</span></code> instance with the MQTT client.</p></li>
<li><p><em><strong>State Change</strong></em> : It triggers the state change on the <code class="docutils literal notranslate"><span class="pre">Zigbee</span></code> and <code class="docutils literal notranslate"><span class="pre">Tasmota</span></code> switch devices.</p></li>
<li><p><em><strong>Note</strong></em> : The <code class="docutils literal notranslate"><span class="pre">switch_power_change_helper()</span></code> method is a convenience method that uses the <code class="docutils literal notranslate"><span class="pre">trigger_change_state()</span></code> method under the hood.</p></li>
</ul>
</section>
</section>
<section id="wrapup">
<h3>Wrapup<a class="headerlink" href="#wrapup" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">switch_power_change()</span></code> : Use this method when you know the protocol and model of the device. It is easier to use because it does not require launching the pipeline and waiting for the devices to be discovered.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">switch_power_change_helper()</span></code> : Use this method when you need more flexibility, such as changing the state of multiple devices with different protocols or models. This method requires initializing the message pipe to discover devices.</p></li>
</ul>
</section>
</section>
<section id="script-customization">
<h2>Script customization<a class="headerlink" href="#script-customization" title="Link to this heading"></a></h2>
<p>The script integration allows users to specify a sequence of actions to be executed according to the state of the devices. The following sections provide examples of how to customize the script.</p>
<section id="example-changing-the-state-of-a-switch-on-motion-detection">
<h3>Example: Changing the State of a Switch on Motion Detection<a class="headerlink" href="#example-changing-the-state-of-a-switch-on-motion-detection" title="Link to this heading"></a></h3>
<p>This example demonstrates how to create a script that changes the state of a switch when motion is detected. The switch will remain on for 15 seconds before turning off.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">iot2mqtt</span> <span class="kn">import</span> <span class="p">(</span><span class="n">central</span><span class="p">,</span> <span class="n">mqtthelper</span><span class="p">,</span> <span class="n">processor</span><span class="p">)</span>
<span class="c1"># Define the MQTT broker hostname</span>
<span class="n">TARGET</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>

<span class="c1"># Define the switch and motion device names</span>
<span class="n">SWITCH</span> <span class="o">=</span> <span class="s2">&quot;SWITCH_CAVE&quot;</span>
<span class="n">MOTION_DEVICE</span> <span class="o">=</span> <span class="s2">&quot;MOTION_CAVE&quot;</span>

<span class="c1"># Define the duration (in seconds) for which the switch should remain on</span>
<span class="n">SHORT_TIME</span> <span class="o">=</span> <span class="mi">15</span> 

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Initialize the MQTT client helper with the specified context</span>
    <span class="n">_client</span> <span class="o">=</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">ClientHelper</span><span class="p">(</span>
        <span class="n">mqtthelper</span><span class="o">.</span><span class="n">MQTTContext</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">TARGET</span><span class="p">),</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">SecurityContext</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">_client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Get the refined data queue from the central module</span>
    <span class="n">_refined_queue</span> <span class="o">=</span> <span class="n">central</span><span class="o">.</span><span class="n">get_refined_data_queue</span><span class="p">(</span><span class="n">_client</span><span class="p">)</span>

    <span class="c1"># Create a device accessor to interact with the devices</span>
    <span class="n">_accessor</span> <span class="o">=</span> <span class="n">central</span><span class="o">.</span><span class="n">DeviceAccessor</span><span class="p">(</span><span class="n">mqtt_client</span><span class="o">=</span><span class="n">_client</span><span class="p">)</span>

    <span class="c1"># Continuously process messages to find motion detection messages</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Retrieve the next message from the queue</span>
        <span class="n">_message</span> <span class="o">=</span> <span class="n">_refined_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="c1"># Check if the message indicates motion detection for the specified device</span>
        <span class="k">if</span> <span class="n">processor</span><span class="o">.</span><span class="n">is_motion_detected</span><span class="p">(</span><span class="n">_message</span><span class="p">,</span> <span class="n">MOTION_DEVICE</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Motion detected, turning switches on for </span><span class="si">{</span><span class="n">SHORT_TIME</span><span class="si">}</span><span class="s1"> sec.&#39;</span><span class="p">)</span>

            <span class="c1"># Change the state of the switch to &#39;on&#39; for the specified duration</span>
            <span class="n">_accessor</span><span class="o">.</span><span class="n">switch_power_change_helper</span><span class="p">(</span>
                <span class="n">device_names</span><span class="o">=</span><span class="n">SWITCH</span><span class="p">,</span> <span class="n">power_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_time</span><span class="o">=</span><span class="n">SHORT_TIME</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># End loop</span>
            <span class="k">return</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<section id="id4">
<h4>Explanation<a class="headerlink" href="#id4" title="Link to this heading"></a></h4>
<p>The script performs the following steps:</p>
<ol class="arabic simple">
<li><p>Connects to the MQTT broker.</p></li>
<li><p>Continuously listens for motion detection messages.</p></li>
<li><p>Turns on the switch when motion is detected and keeps it on for a specified duration.</p></li>
<li><p>Ends the loop when motion is detected.</p></li>
</ol>
</section>
</section>
<section id="example-changing-the-state-of-a-switch-on-button-action">
<h3>Example: Changing the State of a Switch on Button Action<a class="headerlink" href="#example-changing-the-state-of-a-switch-on-button-action" title="Link to this heading"></a></h3>
<p>This example demonstrates how to create a script that changes the state of a switch when a button action is detected. The switch will remain on for a specified duration before turning off.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">iot2mqtt</span> <span class="kn">import</span> <span class="p">(</span><span class="n">abstract</span><span class="p">,</span> <span class="n">central</span><span class="p">,</span> <span class="n">mqtthelper</span><span class="p">,</span> <span class="n">processor</span><span class="p">)</span>
<span class="c1"># Define the MQTT broker hostname</span>
<span class="n">TARGET</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>

<span class="c1"># Define the switch and button device names</span>
<span class="n">SWITCH</span> <span class="o">=</span> <span class="s2">&quot;SWITCH_CAVE&quot;</span>
<span class="n">BUTTON_DEVICE</span> <span class="o">=</span> <span class="s2">&quot;INTER_CAVE&quot;</span>

<span class="c1"># Define the duration (in seconds) for which the switch should remain on</span>
<span class="n">SHORT_TIME</span> <span class="o">=</span> <span class="mi">15</span>  
<span class="n">MEDIUM_TIME</span> <span class="o">=</span> <span class="mi">30</span>  
<span class="n">LONG_TIME</span> <span class="o">=</span> <span class="mi">60</span>  

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Initialize the MQTT client helper with the specified context</span>
    <span class="n">_client</span> <span class="o">=</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">ClientHelper</span><span class="p">(</span>
        <span class="n">mqtthelper</span><span class="o">.</span><span class="n">MQTTContext</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">TARGET</span><span class="p">),</span> <span class="n">mqtthelper</span><span class="o">.</span><span class="n">SecurityContext</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">_client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Get the refined data queue from the central module</span>
    <span class="n">_refined_queue</span> <span class="o">=</span> <span class="n">central</span><span class="o">.</span><span class="n">get_refined_data_queue</span><span class="p">(</span><span class="n">_client</span><span class="p">)</span>

    <span class="c1"># Create a device accessor to interact with the devices</span>
    <span class="n">_accessor</span> <span class="o">=</span> <span class="n">central</span><span class="o">.</span><span class="n">DeviceAccessor</span><span class="p">(</span><span class="n">mqtt_client</span><span class="o">=</span><span class="n">_client</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_button_action</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">switch</span><span class="p">,</span> <span class="n">on_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">power_on</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Handles the button action by turning the switch on or off based </span>
        <span class="c1"># on the action detected.</span>
        <span class="k">if</span> <span class="n">processor</span><span class="o">.</span><span class="n">is_button_action_expected</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
            <span class="n">action_desc</span> <span class="o">=</span> <span class="s1">&#39;on&#39;</span> <span class="k">if</span> <span class="n">power_on</span> <span class="k">else</span> <span class="s1">&#39;off&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Button </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s1"> pressed, turning switches </span><span class="si">{</span><span class="n">action_desc</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">on_time</span><span class="si">}</span><span class="s1"> sec.&#39;</span><span class="p">)</span>
            <span class="n">_accessor</span><span class="o">.</span><span class="n">switch_power_change_helper</span><span class="p">(</span>
                <span class="n">device_names</span><span class="o">=</span><span class="n">switch</span><span class="p">,</span> <span class="n">power_on</span><span class="o">=</span><span class="n">power_on</span><span class="p">,</span> <span class="n">on_time</span><span class="o">=</span><span class="n">on_time</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># Continuously process messages from the refined data queue</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Retrieve the next message from the queue</span>
        <span class="n">_message</span> <span class="o">=</span> <span class="n">_refined_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="c1"># Check if the message indicates button press for the specified device</span>
        <span class="k">if</span> <span class="n">handle_button_action</span><span class="p">(</span>
            <span class="n">_message</span><span class="p">,</span> <span class="n">BUTTON_DEVICE</span><span class="p">,</span> <span class="n">abstract</span><span class="o">.</span><span class="n">ButtonValues</span><span class="o">.</span><span class="n">SINGLE_ACTION</span><span class="p">,</span> <span class="n">SWITCH</span><span class="p">,</span> <span class="n">MEDIUM_TIME</span>
        <span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">handle_button_action</span><span class="p">(</span>
            <span class="n">_message</span><span class="p">,</span> <span class="n">BUTTON_DEVICE</span><span class="p">,</span> <span class="n">abstract</span><span class="o">.</span><span class="n">ButtonValues</span><span class="o">.</span><span class="n">DOUBLE_ACTION</span><span class="p">,</span> <span class="n">SWITCH</span><span class="p">,</span> <span class="n">LONG_TIME</span>
        <span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">handle_button_action</span><span class="p">(</span>
            <span class="n">_message</span><span class="p">,</span> <span class="n">BUTTON_DEVICE</span><span class="p">,</span> <span class="n">abstract</span><span class="o">.</span><span class="n">ButtonValues</span><span class="o">.</span><span class="n">LONG_ACTION</span><span class="p">,</span> <span class="n">SWITCH</span><span class="p">,</span> <span class="n">power_on</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">):</span>
            <span class="k">continue</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

</pre></div>
</div>
<section id="id5">
<h4>Explanation<a class="headerlink" href="#id5" title="Link to this heading"></a></h4>
<p>The script performs the following steps:</p>
<ol class="arabic simple">
<li><p>Connects to the MQTT broker.</p></li>
<li><p>Continuously listens for button action messages.</p></li>
<li><p>Turns on the switch when button press is detected and keeps it on for a specified duration.</p></li>
</ol>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="concepts.html" class="btn btn-neutral float-left" title="Core Concepts" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="modules.html" class="btn btn-neutral float-right" title="iot2mqtt" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Serge LASSABE.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>